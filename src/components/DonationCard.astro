---
const {
  id = `donation-${Math.random().toString(36).slice(2, 8)}`,
  title = "Engangsdonation",
  subtitle = "Støt vores arbejde med et valgfrit beløb.",
  accent = "pink",
  amounts = [25, 50, 100],
  flow = ["amount", "info", "method", "payment", "terms", "thankyou"],

  // NEW: icon next to title
  titleIconSrc,
  titleIconAlt = "",
  titleIconClass = "donation__title-icon",

  // NEW: image in thankyou step
  thankyouImgSrc = "/girls.svg",
  thankyouImgAlt = "",
  thankyouImgClass = "donation__thankyou-img",
} = Astro.props;

const accentClass = accent === "beigepink" ? "donation--beigepink" : "donation--pink";
---

<div
  id={id}
  class={`donation ${accentClass}`}
  data-donation
  data-flow={JSON.stringify(flow)}
>
  <header class="donation__header">
    <div class="donation__title-row">
      <h2 class="t-donation-h1 donation__title">{title}</h2>

      {titleIconSrc && (
        <img
          src={titleIconSrc}
          alt={titleIconAlt}
          class={titleIconClass}
          aria-hidden={titleIconAlt === "" ? "true" : undefined}
        />
      )}
    </div>

    <p class="t-donation-p donation__subtitle">{subtitle}</p>
  </header>

  <div class="donation__body">
    {flow.map((step) => (
      <section class="step hidden" data-step={step}>
        {step === "amount" && (
          <>
            <h4 class="donation__step-title">Vælg beløb</h4>

            <div class="donation__amounts">
              {amounts.map((a) => (
                <button
                  type="button"
                  class="donation__amount-btn"
                  data-amount={a}
                >
                  {a} kr
                </button>
              ))}
            </div>

            <div class="donation__field">
              <label class="sr-only" for={`custom-${id}`}>Valgfrit beløb</label>
              <input
                id={`custom-${id}`}
                class="donation__input custom-amount"
                type="number"
                min="1"
                placeholder="Valgfrit beløb (kr)"
                inputmode="numeric"
              />
            </div>

            <div class="donation__nav">
              <button class="prev hidden donation__nav-btn" type="button">← Tilbage</button>
              <button class="next donation__nav-btn" type="button">Næste →</button>
            </div>
          </>
        )}

        {step === "info" && (
          <>
            <h4 class="donation__step-title">Information</h4>

            <input class="donation__input w-full" placeholder="Fornavn" />
            <input class="donation__input w-full" placeholder="Efternavn" />
            <input class="donation__input w-full" placeholder="Email" />

            <div class="donation__nav">
              <button class="prev hidden donation__nav-btn" type="button">← Tilbage</button>
              <button class="next donation__nav-btn" type="button">Næste →</button>
            </div>
          </>
        )}

        {step === "method" && (
          <>
            <h4 class="donation__step-title">Betalingsmetode</h4>

            <label class="donation__radio">
              <input class="donation__radio-input" type="radio" name={`${id}-method`} value="mobilepay" />
              <span class="donation__radio-ui" aria-hidden="true"></span>
              <span class="donation__radio-text">MobilePay</span>
            </label>

            <label class="donation__radio">
              <input class="donation__radio-input" type="radio" name={`${id}-method`} value="card" />
              <span class="donation__radio-ui" aria-hidden="true"></span>
              <span class="donation__radio-text">Kort</span>
            </label>

            <div class="donation__nav">
              <button class="prev hidden donation__nav-btn" type="button">← Tilbage</button>
              <button class="next donation__nav-btn" type="button">Næste →</button>
            </div>
          </>
        )}

        {step === "payment" && (
          <>
            <h4 class="donation__step-title">Betaling</h4>

            <input class="donation__input w-full" placeholder="Kortnummer" />

            <div class="donation__payment-grid">
              <input class="donation__input" placeholder="MM/ÅÅ" />
              <input class="donation__input" placeholder="CVC" />
              <input class="donation__input" placeholder="Navn" />
            </div>

            <div class="donation__nav">
              <button class="prev donation__nav-btn" type="button">← Tilbage</button>
              <button class="next donation__nav-btn" type="button">Næste →</button>
            </div>
          </>
        )}

        {step === "terms" && (
          <>
            <h4 class="donation__step-title">Betingelser</h4>

            <label class="donation__radio">
              <input type="checkbox" class="donation__radio-input" />
              <span class="donation__radio-ui" aria-hidden="true"></span>
              <span>
                Opret en konto for at administrere mine donationer og donér hurtigere næste gang.
              </span>
            </label>

            <label class="donation__radio">
              <input type="checkbox" class="donation__radio-input" />
              <span class="donation__radio-ui" aria-hidden="true"></span>
              <span>
                Denne formular er beskyttet af reCAPTCHA, og Googles privatlivspolitik og servicevilkår gælder.
              </span>
            </label>

            <div class="donation__nav">
              <button class="prev donation__nav-btn" type="button">← Tilbage</button>
              <button class="next donation__nav-btn" type="button">Donér</button>
            </div>
          </>
        )}

        {step === "thankyou" && (
          <>
            <h4 class="donation__step-title">Tak for din donation!</h4>

            <img
              src={thankyouImgSrc}
              alt={thankyouImgAlt}
              class={thankyouImgClass}
              aria-hidden={thankyouImgAlt === "" ? "true" : undefined}
            />

            <p class="t-donation-form-p donation__thanks">
              Du støtter ikke bare vores hotline - du støtter retten til tryghed i det offentlige rum.
              Tak fordi du handler, når det betyder noget.
            </p>
          </>
        )}
      </section>
    ))}
  </div>

  <script type="module">
    document.querySelectorAll("[data-donation]").forEach((card) => {
      const flow = (() => {
        try {
          return JSON.parse(card.dataset.flow || '["amount","info","method","payment","terms","thankyou"]');
        } catch (err) {
          return ["amount", "info", "method", "payment", "terms", "thankyou"];
        }
      })();

      const steps = flow.map((s) => card.querySelector(`[data-step="${s}"]`)).filter(Boolean);
      if (!steps.length) return;

      let i = 0;

      const prevButtons = Array.from(card.querySelectorAll(".prev"));
      const nextButtons = Array.from(card.querySelectorAll(".next"));

      const show = () => {
        steps.forEach((s, idx) => s.classList.toggle("hidden", idx !== i));
        prevButtons.forEach((btn) => btn.classList.toggle("hidden", i === 0));
        nextButtons.forEach((btn) => btn.classList.toggle("mx-auto", i === 0));
      };

      card.addEventListener("click", (e) => {
        const amtBtn = e.target.closest(".donation__amount-btn");
        if (amtBtn && card.contains(amtBtn)) {
          card.querySelectorAll(".donation__amount-btn").forEach((b) => b.classList.remove("is-selected"));
          amtBtn.classList.add("is-selected");

          const custom = card.querySelector(".custom-amount");
          if (custom) custom.value = "";

          card.dataset.selectedAmount = amtBtn.dataset.amount;
          return;
        }

        if (e.target.closest(".next")) {
          if (i < steps.length - 1) i++;
          show();
          return;
        }

        if (e.target.closest(".prev")) {
          if (i > 0) i--;
          show();
          return;
        }
      });

      card.querySelectorAll(".custom-amount").forEach((input) => {
        input.addEventListener("input", () => {
          card.querySelectorAll(".donation__amount-btn").forEach((b) => b.classList.remove("is-selected"));
          if (input.value && Number(input.value) > 0) {
            card.dataset.selectedAmount = input.value;
          } else {
            delete card.dataset.selectedAmount;
          }
        });

        input.addEventListener("focus", () => {
          card.querySelectorAll(".donation__amount-btn").forEach((b) => b.classList.remove("is-selected"));
        });
      });

      show();
    });
  </script>
</div>